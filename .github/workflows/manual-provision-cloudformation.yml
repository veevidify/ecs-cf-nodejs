# This workflow is manually triggered
# Use to provide the cloudstack from scratch or provide infra update

name: "Provision cloud stack via AWS CloudFormation"

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch:
    # Configurable manual dispatch
    inputs:
      env:
        type: choice
        description: "Staging or production"
        default: "staging"
        required: true
        options:
          - staging
          - production

jobs:
  deploy:
    # runner environment (distro)
    runs-on: ubuntu-latest
    steps:
      - name: Code checkout
        uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.ACCESS_KEY_SECRET }}
          aws-region: ap-southeast-2

      - name: Provision AWS CloudFormation
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: EcsHttpNginxNode
          template: ops/staging/stack.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides:
            - "InstanceType=t3.micro"
